# Plano de Implementa√ß√£o: Sistema de Recrutamento Multiempresa

Sistema web de recrutamento/triagem multiempresa com capta√ß√£o inicial via WhatsApp (sem integra√ß√£o com API do WhatsApp). Arquitetura API-first, responsivo (mobile + desktop), com seguran√ßa, auditoria completa e exporta√ß√£o Excel.

## User Review Required

> [!IMPORTANT]
> **Decis√£o de Stack**: Escolhi a Op√ß√£o A (monorepo Next.js) por simplicidade, custo e velocidade de MVP. Se preferir separar frontend/backend desde o in√≠cio (Op√ß√£o B: Next.js + NestJS), avise antes de prosseguir.

> [!WARNING]
> **Sigilo de Empresas**: Candidatos NUNCA ver√£o o nome da empresa quando `sigilosa=true`. A pergunta de recontrata√ß√£o ser√° gen√©rica. Confirme se essa regra est√° correta.

> [!IMPORTANT]
> **Fluxo de Envio WhatsApp**: Como n√£o h√° integra√ß√£o com WhatsApp API, o sistema:
> 1. Abre `wa.me` com mensagem pr√©-preenchida (evento `WHATSAPP_ABERTO_PARA_ENVIO`)
> 2. Psic√≥loga clica "Marcar como enviado" manualmente (evento `LINK_ENVIADO_CONFIRMADO`)
> 
> Isso exige disciplina da usu√°ria. Confirme se esse fluxo √© aceit√°vel.

---

## Proposed Changes

### Estrutura do Projeto

```
rh/
‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îú‚îÄ‚îÄ schema.prisma          # Modelagem completa do banco
‚îÇ   ‚îî‚îÄ‚îÄ migrations/            # Migra√ß√µes versionadas
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ app/                   # Next.js App Router
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api/               # Route Handlers (backend)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ (auth)/            # Grupo de rotas autenticadas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ (public)/          # Grupo de rotas p√∫blicas
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ layout.tsx         # Layout raiz
‚îÇ   ‚îú‚îÄ‚îÄ components/            # Componentes React (shadcn/ui)
‚îÇ   ‚îú‚îÄ‚îÄ lib/                   # Utilit√°rios
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ prisma.ts          # Cliente Prisma
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.ts            # NextAuth config
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ validators.ts      # CPF, telefone, etc.
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tokens.ts          # Gera√ß√£o e hash de tokens
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ timezone.ts        # Convers√£o UTC ‚Üî BR
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ protocol.ts        # Gerador de protocolo
‚îÇ   ‚îî‚îÄ‚îÄ middleware.ts          # Auth + trace_id
‚îú‚îÄ‚îÄ public/                    # Assets est√°ticos
‚îú‚îÄ‚îÄ .env.local                 # Vari√°veis de ambiente (local)
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ tsconfig.json
‚îî‚îÄ‚îÄ README.md
```

---

### Banco de Dados (Prisma Schema)

#### [NEW] [schema.prisma](file:///c:/Projeto/rh/prisma/schema.prisma)

**Tabelas principais:**

1. **User** (psic√≥logas e admins)
   - `id`, `name`, `email`, `password_hash`, `role` (ADMIN | PSICOLOGA)
   
2. **Company** (empresas clientes)
   - `id`, `nome_interno`, `ativo`, `sigilosa`, `perguntar_recontratacao`, `modo_pergunta_recontratacao` (GENERICO | COM_NOME)
   - **Regra**: `sigilosa=true` for√ßa `modo_pergunta_recontratacao=GENERICO`

3. **Sector** (vagas/setores por empresa)
   - `id`, `company_id`, `nome`, `ativo`

4. **Candidate** (pessoa f√≠sica, reutiliz√°vel)
   - `id`, `phone_normalizado` (√∫nico), `phone_e164` (√∫nico), `name`, `cpf` (√∫nico quando n√£o nulo), `birth_date`, `education`, `vt_value_cents`, `schedule_prefs` (array), `worked_here_before`

5. **Application** (inscri√ß√£o em processo seletivo)
   - `id`, `candidate_id`, `company_id`, `sector_id`, `protocol` (√∫nico), `status` (enum com 11 estados)

6. **InviteToken** (tokens de acesso ao formul√°rio)
   - `id`, `application_id`, `token_hash` (√∫nico), `expires_at`, `used_at`

7. **Event** (auditoria completa)
   - `id`, `application_id`, `candidate_id`, `user_id`, `type` (enum com 15 tipos), `occurred_at`, `notes`, `metadata` (jsonb)

**√çndices de performance:**
- `candidates.phone_normalizado`, `candidates.cpf`
- `applications.protocol`
- `invite_tokens.token_hash`

---

### Autentica√ß√£o e Autoriza√ß√£o

#### [NEW] [auth.ts](file:///c:/Projeto/rh/src/lib/auth.ts)

- **NextAuth** com Credentials provider
- Verifica√ß√£o de senha com `bcrypt`
- Session com `role` (ADMIN | PSICOLOGA)
- RBAC: rotas `/companies`, `/sectors` exigem autentica√ß√£o

#### [NEW] [middleware.ts](file:///c:/Projeto/rh/src/middleware.ts)

- Prote√ß√£o de rotas autenticadas
- Gera√ß√£o de `trace_id` por request (header `X-Trace-Id`)
- Redirecionamento para `/login` se n√£o autenticado

---

### Utilit√°rios e Valida√ß√µes

#### [NEW] [validators.ts](file:///c:/Projeto/rh/src/lib/validators.ts)

**Fun√ß√µes:**
- `validateCPF(cpf: string): boolean` ‚Äî Valida d√≠gitos verificadores
- `normalizeCPF(cpf: string): string` ‚Äî Remove pontos/tra√ßos
- `normalizePhone(phone: string): string` ‚Äî Remove caracteres especiais
- `phoneToE164(phone: string): string` ‚Äî Converte para formato internacional (55DDDNXXXXXXXX)

#### [NEW] [tokens.ts](file:///c:/Projeto/rh/src/lib/tokens.ts)

**Fun√ß√µes:**
- `generateToken(): string` ‚Äî Gera token seguro (32 bytes, base64url)
- `hashToken(token: string): string` ‚Äî SHA-256 hash
- `verifyToken(token: string, hash: string): boolean` ‚Äî Compara token com hash

#### [NEW] [timezone.ts](file:///c:/Projeto/rh/src/lib/timezone.ts)

**Fun√ß√µes:**
- `utcToBrasilia(date: Date): Date` ‚Äî Converte UTC para America/Sao_Paulo
- `brasiliaToUTC(date: Date): Date` ‚Äî Converte America/Sao_Paulo para UTC
- `formatBR(date: Date): string` ‚Äî Formata em dd/MM/yyyy HH:mm

#### [NEW] [protocol.ts](file:///c:/Projeto/rh/src/lib/protocol.ts)

**Fun√ß√£o:**
- `generateProtocol(): string` ‚Äî Gera protocolo √∫nico (ex: `RH-20260211-A3F9`)

---

### Backend - Route Handlers (APIs)

Todas as APIs retornam JSON e seguem o padr√£o:

**Sucesso:**
```json
{ "success": true, "data": {...} }
```

**Erro controlado:**
```json
{
  "error": "Mensagem descritiva",
  "context": "rh-system",
  "trace_id": "abc123",
  "hint": "Ver logs do servidor"
}
```

#### [NEW] [api/companies/route.ts](file:///c:/Projeto/rh/src/app/api/companies/route.ts)

- `GET /api/companies` ‚Äî Lista empresas ativas
- `POST /api/companies` ‚Äî Cria empresa (valida regra: sigilosa ‚Üí modo gen√©rico)
- `PATCH /api/companies/[id]` ‚Äî Atualiza empresa
- `DELETE /api/companies/[id]` ‚Äî Desativa empresa

#### [NEW] [api/sectors/route.ts](file:///c:/Projeto/rh/src/app/api/sectors/route.ts)

- `GET /api/sectors?company_id=X` ‚Äî Lista setores por empresa
- `POST /api/sectors` ‚Äî Cria setor
- `PATCH /api/sectors/[id]` ‚Äî Atualiza setor
- `DELETE /api/sectors/[id]` ‚Äî Desativa setor

#### [NEW] [api/candidates/route.ts](file:///c:/Projeto/rh/src/app/api/candidates/route.ts)

- `GET /api/candidates?search=X` ‚Äî Busca por telefone/CPF/nome
- `GET /api/candidates/[id]` ‚Äî Detalhes + applications

#### [NEW] [api/applications/route.ts](file:///c:/Projeto/rh/src/app/api/applications/route.ts)

- `GET /api/applications` ‚Äî Lista com filtros (status, empresa, setor)
- `POST /api/applications` ‚Äî Cria pr√©-cadastro (telefone + empresa + setor)
  - Cria `Candidate` (s√≥ telefone)
  - Cria `Application` com protocolo
  - Gera `InviteToken` (hash)
  - Registra eventos: `PRE_CADASTRO_CRIADO`, `EMPRESA_SETOR_DEFINIDOS`, `PROTOCOLO_GERADO`, `LINK_GERADO`
- `GET /api/applications/[id]` ‚Äî Detalhes + timeline (events)
- `PATCH /api/applications/[id]/status` ‚Äî Altera status
- `POST /api/applications/[id]/whatsapp-opened` ‚Äî Registra evento `WHATSAPP_ABERTO_PARA_ENVIO`
- `POST /api/applications/[id]/mark-sent` ‚Äî Registra evento `LINK_ENVIADO_CONFIRMADO`, altera status para `LINK_ENVIADO`
- `POST /api/applications/[id]/contact` ‚Äî Registra evento `CONTATO_REALIZADO` com notes

#### [NEW] [api/cadastro/route.ts](file:///c:/Projeto/rh/src/app/api/cadastro/route.ts)

- `GET /api/cadastro/validate-token?token=X` ‚Äî Valida token (n√£o usado, n√£o expirado)
- `POST /api/cadastro/submit` ‚Äî Submete formul√°rio p√∫blico
  - Valida token
  - Valida CPF (d√≠gitos + unicidade)
  - Atualiza `Candidate` com dados completos
  - Marca `InviteToken.used_at`
  - Altera status para `CADASTRO_PREENCHIDO`
  - Registra evento `CADASTRO_PREENCHIDO`
  - **Rate limit**: 10 req/min por IP

#### [NEW] [api/export/applications/route.ts](file:///c:/Projeto/rh/src/app/api/export/applications/route.ts)

- `POST /api/export/applications` ‚Äî Exporta XLSX
  - Filtros: `company_id`, `sector_id`, `date_from`, `date_to`, `status`
  - Aba 1: "Inscri√ß√µes" (dados do candidato + status + datas principais)
  - Aba 2: "Eventos" (timeline completa)
  - Retorna arquivo bin√°rio (`application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`)

---

### Frontend Admin

#### [NEW] [app/(auth)/layout.tsx](file:///c:/Projeto/rh/src/app/(auth)/layout.tsx)

Layout com:
- Header com navega√ß√£o (Dashboard, Empresas, Setores, Candidatos, Nova Inscri√ß√£o)
- Logout
- Responsivo (menu hamb√∫rguer em mobile)

#### [NEW] [app/(auth)/dashboard/page.tsx](file:///c:/Projeto/rh/src/app/(auth)/dashboard/page.tsx)

**Cards de status:**
- Aguardando envio (`LINK_GERADO`)
- Aguardando preenchimento (`LINK_ENVIADO`)
- Cadastro completo (`CADASTRO_PREENCHIDO`)
- Em contato (`EM_CONTATO`)
- Entrevista marcada (`ENTREVISTA_MARCADA`)
- Aprovados (`APROVADO`)
- Reprovados (`REPROVADO`)

**Filas:**
- Lista de applications por status (√∫ltimas 10)

#### [NEW] [app/(auth)/companies/page.tsx](file:///c:/Projeto/rh/src/app/(auth)/companies/page.tsx)

- Tabela com empresas
- Bot√£o "Nova Empresa"
- Modal de cria√ß√£o/edi√ß√£o
- Campos: `nome_interno`, `ativo`, `sigilosa`, `perguntar_recontratacao`, `modo_pergunta_recontratacao`
- **Valida√ß√£o**: Se `sigilosa=true`, `modo_pergunta_recontratacao` deve ser `GENERICO`

#### [NEW] [app/(auth)/sectors/page.tsx](file:///c:/Projeto/rh/src/app/(auth)/sectors/page.tsx)

- Select de empresa
- Tabela de setores da empresa selecionada
- Bot√£o "Novo Setor"
- Modal de cria√ß√£o/edi√ß√£o

#### [NEW] [app/(auth)/candidates/page.tsx](file:///c:/Projeto/rh/src/app/(auth)/candidates/page.tsx)

- Input de busca (telefone/CPF/nome)
- Tabela de resultados
- Ao clicar em candidato ‚Üí lista de applications

#### [NEW] [app/(auth)/applications/new/page.tsx](file:///c:/Projeto/rh/src/app/(auth)/applications/new/page.tsx)

**Formul√°rio:**
1. Input telefone (valida√ß√£o E.164)
2. Select empresa
3. Select setor (filtrado por empresa)
4. Bot√£o "Criar Pr√©-cadastro"

**Ap√≥s cria√ß√£o:**
- Exibe protocolo
- Exibe link de cadastro
- Bot√£o "Abrir WhatsApp para enviar" (abre `wa.me` + registra evento)
- Bot√£o "Marcar como enviado" (registra evento + altera status)
- Bot√£o "Copiar mensagem" (copia texto para clipboard)

**Mensagem WhatsApp:**
```
Ol√°! üòä Tudo bem?
Para concluir seu cadastro no processo seletivo, preencha este link: {LINK}
Protocolo: {PROTOCOLO}
Obrigado!
```

#### [NEW] [app/(auth)/applications/[id]/page.tsx](file:///c:/Projeto/rh/src/app/(auth)/applications/[id]/page.tsx)

**Se√ß√µes:**
1. **Dados do Candidato** (nome, CPF, telefone, VT, escolaridade, data nascimento, hor√°rios, recontrata√ß√£o)
2. **Dados da Inscri√ß√£o** (empresa, setor, protocolo, status)
3. **Linha do Tempo** (events ordenados por `occurred_at`)
   - √çcone por tipo de evento
   - Data/hora formatada (BR)
   - Usu√°rio respons√°vel (se houver)
   - Notas
4. **A√ß√µes**
   - Reenviar WhatsApp (gera novo token + evento `REENVIO_LINK`)
   - Marcar como enviado
   - Registrar contato (modal com textarea para notes)
   - Alterar status (select)
   - Editar candidato (modal, apenas ADMIN)

---

### Frontend P√∫blico

#### [NEW] [app/(public)/cadastro/t/[token]/page.tsx](file:///c:/Projeto/rh/src/app/(public)/cadastro/t/[token]/page.tsx)

**Valida√ß√£o inicial:**
- Verifica se token existe e n√£o foi usado
- Se inv√°lido/expirado ‚Üí exibe erro

**Formul√°rio (sigilo total):**
- Nome completo
- CPF (valida√ß√£o + m√°scara)
- Telefone (travado, exibido mas n√£o edit√°vel)
- Valor VT (R$, input num√©rico)
- Escolaridade (select: Fundamental, M√©dio, Superior, P√≥s-gradua√ß√£o)
- Data de Nascimento (date picker)
- Prefer√™ncia de hor√°rio (checkboxes: Manh√£, Tarde, Noite)
- **Pergunta condicional** (se `company.perguntar_recontratacao=true`):
  - Se `sigilosa=false` e `modo=COM_NOME`: "Voc√™ j√° trabalhou na {NOME}?"
  - Caso contr√°rio: "Voc√™ j√° trabalhou nesta empresa anteriormente?"
  - Resposta: SIM / N√ÉO

**Submit:**
- Valida todos os campos
- Envia para `POST /api/cadastro/submit`
- Exibe mensagem de sucesso: "Cadastro conclu√≠do! Protocolo: {PROTOCOLO}"

---

### WhatsApp Deep Link

#### [NEW] [whatsapp.ts](file:///c:/Projeto/rh/src/lib/whatsapp.ts)

**Fun√ß√£o:**
```typescript
function generateWhatsAppLink(phone: string, protocol: string, link: string): string {
  const phoneE164 = phoneToE164(phone); // 55DDDNXXXXXXXX
  const message = `Ol√°! üòä Tudo bem?\nPara concluir seu cadastro no processo seletivo, preencha este link: ${link}\nProtocolo: ${protocol}\nObrigado!`;
  return `https://wa.me/${phoneE164}?text=${encodeURIComponent(message)}`;
}
```

**Eventos:**
- Ao clicar "Abrir WhatsApp" ‚Üí `window.open(link)` + `POST /api/applications/[id]/whatsapp-opened`
- Ao clicar "Marcar como enviado" ‚Üí `POST /api/applications/[id]/mark-sent`

---

### Exporta√ß√£o Excel

#### [NEW] [export.ts](file:///c:/Projeto/rh/src/lib/export.ts)

**Biblioteca:** `xlsx` (SheetJS)

**Aba 1: Inscri√ß√µes**
Colunas:
- Protocolo
- Nome
- CPF
- Telefone
- Empresa
- Setor
- Status
- Data Pr√©-cadastro
- Data Link Gerado
- Data Link Enviado
- Data Cadastro Preenchido

**Aba 2: Eventos**
Colunas:
- Protocolo
- Tipo de Evento
- Data/Hora
- Usu√°rio
- Notas

---

## Verification Plan

### Automated Tests

1. **Valida√ß√£o de CPF**
   ```bash
   npm test -- validators.test.ts
   ```
   - CPF v√°lido: `12345678909`
   - CPF inv√°lido: `11111111111`, `12345678900`

2. **Normaliza√ß√£o de telefone**
   ```bash
   npm test -- validators.test.ts
   ```
   - `(11) 98765-4321` ‚Üí `11987654321` ‚Üí `5511987654321`

3. **Hash de tokens**
   ```bash
   npm test -- tokens.test.ts
   ```
   - Token gerado √© √∫nico
   - Hash √© consistente

4. **Sigilo de empresa**
   ```bash
   npm test -- cadastro.test.ts
   ```
   - Formul√°rio p√∫blico NUNCA exibe nome da empresa se `sigilosa=true`

5. **Rate limiting**
   ```bash
   npm test -- rate-limit.test.ts
   ```
   - 11¬™ requisi√ß√£o em 1 minuto retorna 429

### Manual Verification

1. **Fluxo completo (happy path)**
   - Login como psic√≥loga
   - Criar empresa + setor
   - Criar pr√©-cadastro (telefone + empresa + setor)
   - Abrir WhatsApp (verificar mensagem)
   - Marcar como enviado
   - Acessar link p√∫blico (outro navegador/an√¥nimo)
   - Preencher formul√°rio
   - Verificar timeline no admin
   - Exportar Excel

2. **Valida√ß√µes de neg√≥cio**
   - Tentar criar empresa sigilosa com modo `COM_NOME` ‚Üí deve for√ßar `GENERICO`
   - Tentar cadastrar CPF duplicado ‚Üí deve retornar erro
   - Tentar usar token j√° usado ‚Üí deve retornar erro

3. **Responsividade**
   - Testar todas as telas em mobile (Chrome DevTools)
   - Verificar overflow horizontal
   - Verificar bot√µes acess√≠veis

4. **Timezone**
   - Criar application √†s 23:50 (hor√°rio local)
   - Verificar se `occurred_at` est√° em UTC no banco
   - Verificar se timeline exibe hor√°rio BR correto

---

## Medidas Preventivas

### Anti-500 (Sistema Imunol√≥gico)

1. **Middleware de trace_id** (obrigat√≥rio)
2. **Handler global de exce√ß√µes** em todas as Route Handlers:
   ```typescript
   try {
     // l√≥gica
   } catch (error) {
     logger.exception(error, { trace_id });
     return NextResponse.json({
       error: "Erro interno controlado",
       context: "rh-system",
       trace_id,
       hint: "Ver logs do servidor"
     }, { status: 500 });
   }
   ```

### Anti-Cache (DEV)

Headers em todas as rotas HTML:
```typescript
export const dynamic = 'force-dynamic';
export const revalidate = 0;
```

### Anti-Duplicidade

- √çndices √∫nicos: `phone_normalizado`, `cpf`, `protocol`, `token_hash`
- Valida√ß√£o antes de insert

### Anti-Timezone

- Armazenar sempre UTC
- Converter para BR apenas na exibi√ß√£o
- Usar `date-fns-tz` para convers√µes

### Logs Estruturados

```typescript
logger.info('Application created', {
  trace_id,
  user_id,
  application_id,
  protocol
});
```

---

## Checklist de Valida√ß√£o Final

- [ ] Login funciona (admin + psic√≥loga)
- [ ] CRUD empresas/setores funciona
- [ ] Pr√©-cadastro gera protocolo + token + link
- [ ] Bot√£o WhatsApp abre `wa.me` com mensagem correta
- [ ] Eventos s√£o registrados corretamente
- [ ] Formul√°rio p√∫blico valida CPF
- [ ] Formul√°rio p√∫blico respeita sigilo
- [ ] Timeline exibe eventos em ordem cronol√≥gica (BR)
- [ ] Exporta√ß√£o Excel gera 2 abas
- [ ] Rate limiting funciona no endpoint p√∫blico
- [ ] Headers anti-cache em DEV
- [ ] Nenhum erro 500 sem trace_id
- [ ] README completo com instru√ß√µes de deploy
